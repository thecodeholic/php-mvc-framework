<?php

// If no arguments were provided in the command line
if (!isset($argv[1])) {
    throw new Exception('!!! No command-line arguments were provided !!!');
    exit;
}

// Re-arrange the command-line arguments
$arguments = restructureArgsArray($argv);

// Compare command-line arguments and execute their corresponding code
switch ($argv[1]) {
    // For command 'php codeholic serve'
    case 'serve':
        serveTheApp($arguments);
        break;

    // If an invalid command-line argument is provided
    default:
        throw new Exception("!!! Invalid command line argument: [ $argv[1] ] !!!");
        break;
}

/**
 * Re-arrange the user provided command line arguments
 * 
 * @param array $argv => Contains command-line arguments provided by the user
 * 
 * @return array $newArgsArray => Contains restructered command-line arguments
 */
function restructureArgsArray(array $args)
{
    // Remove first two 'key => value' pairs from the array as they are not really neeeded
    $args = array_slice($args, 2);

    $newArgsArray = [];

    // Convert each array element to a new 'key => value' pair
    // For example, '--port=8080' to '--port' => '8080'
    foreach ($args as $arg) {
        if (strpos($arg, '=')) {
            $newArgsArray[strtok($arg, '=')] = strtok('');
            continue;
        }

        $newArgsArray[$arg] = false;
    }

    return $newArgsArray;
}

/**
 * Serve the app using the command 'php codeholic serve'
 * 
 * @param array $argsArray => A restructered array containing command-line arguments
 * 
 * @return null
 */
function serveTheApp(array $argsArray)
{
    $pathToMainIndex    =   'public/';      // Path to the entry point of our app
    $host               =   '127.0.0.1';    // Default 'host' url for our app
    $port               =   8080;           // Default port for our app to use
    $maxPort            =   null;           // Decide max port to try running PHP's built-in server on before the failure 

    // Possible parameters for the 'php codeholic serve' command
    // For example, '--port=8080', '--host=127.0.0.1', '--max-port=9010'
    $possibleParams = [
        'host'      =>  '--host',
        'port'      =>  '--port',
        'maxPort'   =>  '--max-port'
    ];

    // If an invalid parameter is encountered, throw the exception
    foreach ($argsArray as $arg => $value) {
        if (!in_array($arg, $possibleParams)) {
            throw new Exception("!!! 'php codeholic serve': Invalid parameter [ $arg ] !!!");
            exit;
        }

        // If no value for parameter is passed, throw the exception
        // In future, this needs to be changed, if we introduce a new parameter that does not require a value
        if (!$value) {
            throw new Exception("!!! 'php codeholic serve': Invalid value for the parameter [ $arg ] !!!");
            exit;
        }
    }

    // If the user provides a custom host url
    if (array_key_exists($possibleParams['host'], $argsArray)) {
        $host = $argsArray[$possibleParams['host']];
    }

    // If the user provides a custom port number
    if (array_key_exists($possibleParams['port'], $argsArray)) {
        $port = $argsArray[$possibleParams['port']];
    }

    // If the user explicitly specifies max port limit
    if (array_key_exists($possibleParams['maxPort'], $argsArray)) {
        // If the maximum port is less than the the minimum port number, throw an exception
        if ($argsArray[$possibleParams['maxPort']] < $port) {
            throw new Exception('The maximum port number cannot be lesser than the currently set port number');
        }
        $maxPort = $argsArray[$possibleParams['maxPort']];
    }

    // If default port is free, run PHP's built-in server on it
    if (exec(`php -S $host:$port -t $pathToMainIndex`)) {
        return;
    }

    // If PHP version is 8.0.0 or up, dynamically select a port to run PHP's built-in server on
    if (version_compare(phpversion(), '8.0.0') > -1) {
        exec(`php -S $host:0 -t $pathToMainIndex`);
        return;
    }

    // If PHP version is less than 8.0.0, execute following code
    $port++;  // Increment 'port number', as default port is not available for the use
    $portLimit = $maxPort ?? $port + 60;  // To set the limit of iterations for the while loop below
    $portIsFree = false;

    // Run PHP's built-in server on a port that is available for use
    while (!$portIsFree) {
        // If the PHP's built-in server can be run on the current port, stop the loop
        if (exec(`php -S $host:$port -t $pathToMainIndex`)) {
            $portIsFree = true;
            break;
        }

        // Limit the iterations of the loop
        // We don't want this loop to run like forever
        if ($port > $portLimit) {
            throw new Exception('!!! App failed to run. Ports limit exceeded. Maybe, try a different ports range !!!');
            break;
        }

        $port++;
    }
}
